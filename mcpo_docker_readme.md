# מדריך לבנייה ופריסה של Docker (פרויקט mcpo)

מדריך זה מסדר באופן שיטתי את תהליך הבנייה, הפריסה, פתרון בעיות ושיטות העבודה המומלצות עבור פרויקט mcpo בסביבת קונטיינר Docker, ומשקף את מצב הפרויקט העדכני ביותר.

---

## א. סקירת הפרויקט והארכיטקטורה

הפרויקט משתמש ב-Docker וב-Docker Compose לצורך פריסה בקונטיינר של `mcpo` (Model Context Protocol OpenAPI Proxy). עקרונות העיצוב המרכזיים כוללים:

- **התקנת תלות דינמית**: בעת הפעלת הקונטיינר, סקריפט `run_mcpo.sh` קורא את `config.json` ומתקין באופן דינמי את הכלים הנדרשים של Python (`uvx`) ושל Node.js (`npx`).
- **הרצה ללא משתמש root**: הקונטיינר מופעל בסופו של דבר תחת משתמש שאינו root בשם `appuser`, לשיפור האבטחה.
- **התמדה של תלות ונתונים**: באמצעות Docker Compose, הקונפיגורציה, הלוגים, הנתונים ותיקיות המטמון של `uv` ו-`npm` נשמרים על גבי המארח.
- **קונפיגורציה גמישה של מקורות**: תמיכה בקונפיגורציה דינמית של מקורות `pip` באמצעות פרמטרי בנייה (`PIP_SOURCE`), ובברירת מחדל שימוש במראה של עליבאבא להאצת `apt`.
- **בידוד סביבתי**: כל התקנה של כלי MCP בסקריפט `run_mcpo.sh` מתבצעת בתוך shell משנה, כדי למנוע התנגשויות של משתני סביבה.

---

## ב. תהליך הבנייה והפריסה

### 1. הכנת הסביבה

- **Docker & Docker Compose**: מומלץ להשתמש ב-Docker גרסה 24+ וב-Docker Compose גרסה 2.x.
- **קובץ `.env`**: יש ליצור קובץ `.env` בתיקיית השורש של הפרויקט, לצורך אחסון מידע רגיש וקונפיגורציה. הקובץ כולל את `MCPO_API_KEY`. ניתן להיעזר בקובץ `.env` כדוגמה.

  ```dotenv
  # דוגמה לקובץ .env
  # מקור pip לבנייה של Docker (אופציונלי, אם ריק ייעשה שימוש במקור ברירת המחדל)
  PIP_SOURCE=https://mirrors.aliyun.com/pypi/simple/

  # מפתח API נדרש להפעלת mcpo (חובה)
  MCPO_API_KEY=your_mcpo_api_key_here

  # מפתחות API נוספים שייתכן ויידרשו על ידי שרתי MCP (בהתאם לקונפיגורציה ב-config.json)
  # AMAP_MAPS_API_KEY=your_amap_key
  # ... משתני סביבה נוספים
  ```

- **`config.json`**: קובץ קונפיגורציה שמגדיר את שרתי MCP שיש להפעיל. ניתן להיעזר בקובץ `config.example.json` כדוגמה.
- **רשת**: יש לוודא שניתן לגשת ל-Debian (מראה של עליבאבא), NodeSource, PyPI (או מקור `PIP_SOURCE` מוגדר).

### 2. מבנה תיקיות וקבצים חשובים

- `Dockerfile.mcpo`: מגדיר את תהליך הבנייה של התמונה.
  - תמונת בסיס: `python:3.13-slim`
  - התקנה: `bash`, `curl`, `jq`, `nodejs` (v22.x), `git`, `uv` (דרך pip)
  - משתמש: יצירת `appuser` והרצה תחתיו.
  - קונפיגורציה: תמיכה בפרמטר בנייה `PIP_SOURCE`.
- `start.sh`: סקריפט נקודת כניסה לקונטיינר.
  - הגדרת `HOME`, `UV_CACHE_DIR`, `NPM_CONFIG_CACHE`.
  - יצירת תיקיות התמדה.
  - קריאת `config.json` והתקנה דינמית של כלי MCP (באמצעות `uvx` או `npx`).
  - הפעלת שירות `mcpo` הראשי.
- `docker-compose.yml`: מגדיר שירותים, פרמטרי בנייה, תלות, משתני סביבה.
  - העברת `PIP_SOURCE` ל-Dockerfile.
  - תלות: `./config.json`, `./logs`, `./data`, `./node_modules`, `./.npm`, `./.uv_cache`.
  - טעינת `.env` כמשתני סביבה בזמן הרצה.
- `readme-docker.md`: מסמך זה.
- `test_mcp_tools.sh`: סקריפט לבדיקת פונקציונליות בסיסית.

### 3. בניית תמונה

```bash
# העברת PIP_SOURCE (אם מוגדר ב-.env, compose יטען אותו אוטומטית)
docker-compose build [--no-cache]
```

- `--no-cache`: בנייה מחדש של כל השכבות, לצורך הבטחת עדכונים.
- תהליך הבנייה ישתמש במקור `PIP_SOURCE` המוגדר בקובץ `.env` (אם קיים).

### 4. הפעלת שירות

```bash
# הפעלת שירות (הרצה ברקע)
docker-compose up -d
```

- `docker-compose.yml` יטען את משתני הסביבה מקובץ `.env`.
- `start.sh` יבוצע, יתקין באופן דינמי את כלי MCP המוגדרים ב-`config.json`.
- שירות `mcpo` הראשי יופעל.

---

## ג. פתרון בעיות נפוצות

### 1. `npx: command not found` / `git: command not found`

- **סיבה**: `npx` (מותקן עם `nodejs`) או `git` לא מותקנים או לא נמצאים בנתיב `PATH` של המשתמש `appuser`.
- **פתרון**:
  - יש לוודא ש-Dockerfile כולל את `apt-get install` עבור `nodejs` ו-`git`.
  - יש לוודא שהוראת `ENV PATH` כוללת את `/usr/bin` (בדרך כלל `apt` מתקין את `nodejs` ו-`git` שם). Dockerfile כבר כולל `/app/.local/bin:/usr/bin:/usr/local/bin:$PATH`.
  - יש לבצע `docker-compose build --no-cache` לבנייה מחדש.

### 2. `mkdir: cannot create directory '/root': Permission denied`

- **סיבה**: הקונטיינר מופעל תחת משתמש שאינו root בשם `appuser`, אך סקריפט או תלות מנסים לכתוב לתיקיית `/root` (כגון נתיב מטמון ברירת מחדל).
- **פתרון**:
  - תיקיות המטמון (`uv`, `npm`) כבר הועברו באמצעות הוראות `ENV` (`UV_CACHE_DIR`, `NPM_CONFIG_CACHE`, `HOME`) ל-`/app`.
  - ב-`start.sh`, הפקודה `mkdir -p` פועלת רק על תיקיות תחת `/app`.
  - ב-`docker-compose.yml`, נתיבי תלות המותקנים עודכנו ל-`/app/...`.

### 3. `pip` לא משתמש במקור מותאם אישית (`PIP_SOURCE`)

- **סיבה**: במהלך הבנייה, `PIP_SOURCE` לא הועבר כראוי ל-Dockerfile.
- **פתרון**:
  - יש לוודא שקובץ `.env` כולל `PIP_SOURCE=https://...`.
  - יש לוודא ש-`docker-compose.yml` כולל את `build.args` עם `- PIP_SOURCE=${PIP_SOURCE:-}`.
  - Dockerfile משתמש ב-`ARG PIP_SOURCE` ומגדיר אותו באמצעות `export PIP_INDEX_URL` בשכבת `RUN`.

### 4. התקנה איטית/כושלת של תלות

- **סיבה**: חיבור רשת חלש, גישה איטית או כושלת למקורות רשמיים.
- **פתרון**:
  - Dockerfile כבר מוגדר לשימוש במראה של עליבאבא להאצת `apt`.
  - ניתן להגדיר מראה מקומי עבור `pip` בקובץ `.env`.
  - Node.js (NodeSource) ו-uv (PyPI/Mirror) עדיין תלויים ברשת, במקרים קיצוניים יש לשקול פתרונות חלופיים.

---

## ד. נקודות מפתח ושיטות עבודה מומלצות

- **משתמש שאינו root**: תמיד להפעיל את הקונטיינר תחת `appuser`.
- **התמדה**: יש להגדיר תלות עבור `config.json`, `logs`, `data`, `node_modules`, `.npm`, `.uv_cache` כדי לשמור על מצב ותלות.
- **סודות**: יש לנהל מפתחות API ומידע רגיש באמצעות קובץ `.env`, ולהזריק אותם באמצעות `env_file`. **אין** להעתיק את קובץ `.env` לתוך התמונה או להכניס מפתחות בקוד. יש להוסיף את `.env` ל-`.gitignore`.
- **התקנה דינמית**: מנגנון ההתקנה הדינמית של `run_mcpo.sh` מספק גמישות, אך גם גורם לזמן הפעלה ארוך יותר בפעם הראשונה או לאחר שינוי ב-`config.json`.
- **גרסאות קבועות**: לשיפור שחזוריות, מומלץ לקבע גרסאות של `uv` ב-Dockerfile (`pip install --user uv==X.Y.Z`) ושל חבילות `npx` ב-`config.json` (`@amap/amap-maps-mcp-server@X.Y.Z`).
- **הגבלת משאבים**: בסביבת ייצור, יש לשקול הגדרת מגבלות זיכרון ו-CPU עבור השירות ב-`docker-compose.yml`.
- **לוגים**: לוגים נשמרים בתיקיית `./logs`, לנוחות צפייה וניהול.
- **בדיקות**: יש להשתמש בסקריפט `test_mcp_tools.sh` לצורך אימות פונקציונליות בסיסית.

---

## ה. פקודות עזר

- בניית תמונה: `docker-compose build [--no-cache]`
- הפעלת שירות (ברקע): `docker-compose up -d`